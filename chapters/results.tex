% !TeX root = ../Thesis.tex
\chapter{Analysis}\label{chap:analysis}

% \definecolor{darkgray176}{RGB}{176,176,176}
% \definecolor{lightblue158218229}{RGB}{158,218,229}

% \begin{groupplot}[group style={group size=1 by 2}]
% \nextgroupplot[
% xlabel={$y$[m]},
% grid=both,
% xmin=1, xmax=3,
% ymin=0, ymax=1.5,
% y dir=reverse,
% ylabel={$x$ [m]},
% axis equal,
% legend entries={Actual Position,
%                 Replanned Target Path},
% ]
% \addlegendimage{no markers,red, thick}
% \addlegendimage{no markers,lightblue158218229, thick}
\begin{itemize}
	\color{red}
	\item Test the dynamic behavior of the body rates to assess whether the assumptions that they are reached slowly and by far not instantaneously holds.
	\item real time capability on limited hardware is required for deployment -> analysis of computation times required for assessment
	\item single trajectory tracking without implicit feedback, to analyze performance of (half) open loop trajectory tracking. while keeping disturbances at a minimum, this should show how susceptible the tracking performance is for errors in the assumed model parameters.
	\item Multi Trajectory/Implicit Feedback should show the full capability of the approach. Collision avoidance can be added optionally
\end{itemize}


\section{Analysis Setup}
The following section provides details on the simulation and the experimental testbed used for the analysis of the proposed methodology.
\subsection{Simulation Environment}
The numerical studies of this thesis are conducted within the Gazebo simulation environment. 
Gazebo is chosen for its seamless integration into the ROS world.
This is particularly beneficial as Gazebo allows testing in the developed trajectory planning and control framework in a software-in-the-loop-like manner, i.\,e. the software implementation for simulation is identical to the implementation onboard the underwater robot.
Note that the upgrade from the legacy ROS version \textit{one} towards ROS2 required upgrading the Gazebo implementation as well.
\Cref{fig:analysis_setups} shows a screenshot of the Gazebo simulator.
The simulation parameters are summarized in \Cref{tab:sim_parameters}.
\textcolor{red}{
\begin{itemize}
    \item where do the parameter come from?
    \item what else to consider here? 
\end{itemize}}

\textcolor{red}{
\begin{table}[]
        \caption{Overview on Model Parameters for the Gazebo Simulation.}
		%\hspace*{-1.5cm}  % move table down (left in landscape) - tabular width: 
		\centering
		% change column width: >{\hsize=1.5\hsize\linewidth=\hsize}
		% >{\hsize=0.5\hsize\linewidth=\hsize}
		\begin{NiceTabular}
            {
            %%%%% Leider scheint die beste Methode wirklich hardgecodete Spaltenbreiten zu sein - hier am Ende rumspielen
            >{\centering\arraybackslash}m{3cm}  %
            >{\centering\arraybackslash}m{3cm} % 
            }
            \toprule
            %%%%%%%%%%% Top row - names of each columns
            Parameter &  Value \\  
            \midrule 
            %%%%%%%% Beispiel
            mass $m$ & $1$\,kg \\
            added mass $m_\mathrm{a}$ & \,kg \\
            damping $d_\mathrm{v}$ &  \\
            inertia $I_\mathrm{x}$ &  \\
            inertia $I_\mathrm{y}$ &  \\
            inertia $I_\mathrm{z}$ &  \\
            \bottomrule
		\end{NiceTabular}
		\label{tab:sim_parameters}
\end{table}
}
\begin{figure}
    \centering
    \includegraphics[width=0.4\textwidth]{images/04/roboquarium_tested_topview.jpg}
    \quad\quad
    \includegraphics[width=0.4\textwidth]{images/04/roboquarium_tested_topview.jpg}
    \caption{Analysis setup for performance evaluations. Gazebo for simulation studies (\textit{left}) and top-view of the \textit{Roboquarium} underwater robot testbed (\textit{right}).}
    \label{fig:testbed_topview}
    \label{fig:analysis_setups}
\end{figure}
\subsection{Experimental Testbed}
Evaluating the performance of the proposed methodology in real-world experiments is an important step in the development process.
The physical experiments of this work have been conducted at the underwater robotics testing facilities \textit{Roboquarium} at the Institute of Mechanics and Ocean Engineering at TU Hamburg.
The dimensions of the used water basin are $4\times2\times1.5\,\mathrm{m}^3$.
\Cref{fig:testbed_topview} shows a photo of the testbed.
The tank is filled with fresh water that is continuously filtered and provides good visibility conditions as required by vision-based localization systems.
Furthermore, the tank floor is equipped with an array of AprilTag markers (Tag-Family 36h11, size $7.5$\,cm, $25$\,cm spacing in $X$-direction, $30$\,cm in $Y$-direction) to allow the usage of the onboard $\mu$AUV self-localization system described in \cite{Duecker20}.


\begin{figure}
    \centering
    \includegraphics[width=0.7\textwidth]{images/04/hippo_in_tank.png}
    \caption{\textcolor{blue}{HippoCampus \ac{uauv} in experimental testbed.}}
    \label{fig:my_label}
\end{figure}


\subsubsection*{Qualisys Motion Capture System}
Recently, the Roboquarium testbed has been equipped with a professional underwater motion capture system to provide high-precision ground truth pose data of the tracked underwater objects.
The installed motion capture system features four \textit{Qualisys\,Miqus\,3} underwater cameras that are mounted into the corners of the water basin, as shown in \Cref{fig:testbed_topview}.
Prior to the experiment, the objects to be tracked, i.\,e. the \ac{uauv}, are equipped with multiple reflective markers, as depicted in \Cref{fig:hippo_with_marker}. 
In the current setup, the motion capture system provides 6-DOF data of pre-defined underwater objects at 100\,Hz, see also the 3D-overlay in \Cref{fig:qtm_3d} and the multi-camera reflection intensity view in \Cref{fig:qtm_intensity}.
Note that the motion captures system has been integrated into the Roboquarium ROS network.
This allows to use the data live within the experiment, e.\,g. as a pose data for the vehicle control loops.

Prior the experimental study, the motion capture system is calibrated to determine the camera positions with respect to the base frame origin. 
Moreover, the averaged residuals are computed using the software \textit{Qualisys Tracking Manager} (QTM).
The parameters are summarized in \Cref{tab:mocap_parameters}.


\begin{figure}
    \centering
    \includesvg[width=6cm]{images/04/hippo_with_markers}
    \caption{\textcolor{blue}{HippoCampus \ac{uauv} equipped with reflective markers. Note that the black tape is used to avoid reflections on the acrylic glas enclosure that can be misinterpreted as markers.}}
    \label{fig:hippo_with_marker}
\end{figure}


\begin{figure}
    \centering
    \includegraphics[width=0.9\textwidth]{images/04/qtm_3d_overlay.png}
    \caption{3D-overlay with tracked vehicle (yellow skeleton), the frame origin, and the four cameras provided by the Qualisys QTM software.}
    \label{fig:qtm_3d}
\end{figure}

\begin{figure}
    \centering
    \includegraphics[width=0.9\textwidth]{images/04/qtm_multi_cam_intensity.png}
    \caption{Multi-camera view with reflective intensity from \textit{blue} (low intensity) to \textit{red} (high intensity).}
    \label{fig:qtm_intensity}
\end{figure}

% \begin{itemize}
%     \item Figure sketch - 4 cameras inside the tank (+ maybe screenshot from QTM?)
%     \item photo of sexy blue glowing cameras
%     \item photo of hippocampus with reflective markers
%     \item after conducting the QTM calibration procedure the estimated accuracy wihtin the calibration is XXXXXX according to the QTM calibration process.
% \end{itemize}

\begin{table}[]
        \caption{Calibration Parameters of Motion Capture System.}
		%\hspace*{-1.5cm}  % move table down (left in landscape) - tabular width: 
		\centering
		% change column width: >{\hsize=1.5\hsize\linewidth=\hsize}
		% >{\hsize=0.5\hsize\linewidth=\hsize}
		\begin{NiceTabular}
            {
            %%%%% Leider scheint die beste Methode wirklich hardgecodete Spaltenbreiten zu sein - hier am Ende rumspielen
            >{\centering\arraybackslash}m{2cm}  %
            >{\raggedleft\arraybackslash}m{1.7cm} % 
            >{\raggedleft\arraybackslash}m{1.7cm} %
            >{\centering\arraybackslash}m{1.7cm} %
            >{\centering\arraybackslash}m{2.2cm} %
            >{\centering\arraybackslash}m{2cm} %
            }
            \toprule
            %%%%%%%%%%% Top row - names of each columns
            Camera\,\# &  X\,(mm) & Y\,(mm) & Z\,(mm) & Calibration Points & Average Residual (mm) \\  
            \midrule 
            %%%%%%%% Beispiel
            01 & -1\,126.29 & -1\,346.14 & 1\,360.69 & 1\,891 & 0.5458 \\
            02 &     460.29 &  1\,357.67 & 1\,360.02 & 1\,584 & 0.6037\\
            03 &     483.47 &  2\,022.77 & 1\,350.27 & 1\,332 & 0.7383\\
            04 & -1\,055.28 &  2\,049.69 & 1\,326.27 & 1\,500 & 0.6270\\
            \bottomrule
		\end{NiceTabular}
		\label{tab:mocap_parameters}
\end{table}



\section{Body Rates Analysis}
\begin{figure}
	\centering
	\begin{tikzpicture}
		\begin{axis}[
			no markers,
			width=0.9\textwidth,
			height=7cm,
			grid=both,
			% ymax=1.5,
			xmax=0.7,
			enlarge x limits=false,
			xlabel={Time [s]},
			ylabel={Angular rate [\unit{rad/s}]},
			]
			\addplot+[thick] table [x=t, y=v_ang, col sep=comma] {data/lab/rates_saturation.csv};
		\end{axis}
	\end{tikzpicture}
	\caption{Angular rate for thrusters in saturation around the vehicle's vertical axis $\ezbody$. Maximum rate is ca. \unit[6.15]{rad/s}}. \unit[63]{\%} of the maximum is reached around $\tau \approx \unit[0.3]{s}$.
\end{figure}

\begin{itemize}
	\color{red}
	\item Useful for myself to get reasonable values for the body rate limit
	\item Either use the body rate controller or just feed through
	\item Use step function and compute the time constant?
	\item Only test pitch/yaw. Roll is irrelevant
\end{itemize}

\section{Computational Performance}
\begin{figure}%[H]
	\centering
	\begin{tikzpicture}
		\begin{axis}[
			width=0.4\textwidth,
			height=7cm,
			boxplot/draw direction=y,
			xtick={0, ..., 5},
			xticklabels={Input Check, Collision Check, Input Feasible, Input Infeasible, Collision Feasible, Collision Infeasible},
			xticklabel style = {align=right, rotate=60, anchor=east},
			% x tick label as interval,
			ymajorgrids,
			% ytick distance={20},
			% minor y tick num=4,
			ymax=1250, ymin=0,
			% every box/.style={line, draw=mumblue, marker=o},
			% every whisker/.style={line, mumblue},
			cycle list={{mumblue}},
			ylabel={Computation time [\unit{ns}]},
			xlabel={Zeitfenster},
			boxplot={
				draw position={\plotnumofactualtype}
			},
			]
			
			\pgfplotsforeachungrouped \i in {1,...,6}
			{
				\addplot+[boxplot, draw=mumblue, mark=none, thick] table [col sep=comma, y index=\i]{plots/perf_dat/t_all.dat};
			}
		\end{axis}
		% \node[below left] at (border.north east) {\ref{legend}};
	\end{tikzpicture}
	\caption{Computation time over 1000 samples. Input and collision feasibility check for all results and separated by feasibility result.}
	\label{fig:computation-time-desktop}
\end{figure}

\begin{itemize}
	\color{red}
	\item Measure the following
	\begin{itemize}
		\item generation time (expected to be constant, small variance due to running on a best effort machine)
		\item input feasibility (a recursive algorithm. maybe have a special look on worst case)
		\item position feasibility (only extrema need to be considered. small variance expected)
		\item collision avoidance ()
	\end{itemize}
	\item Tabular, or BoxPlot? Or Barplot? 
\end{itemize}

\section{Single Trajectory Tracking}


\section{Implicit Feedback}

\input{plots/sim/implicit/replanning_xy_perfect.tex}
\input{plots/sim/implicit/replanning_xy_damping_4.9.tex}
\input{plots/sim/implicit/replanning_xy_damping_4.4.tex}
\input{plots/sim/implicit/replanning_xy_damping_5.9.tex}
\input{plots/sim/implicit/replanning_xy_damping_6.4.tex}

\begin{figure}
	\centering
	\input{plots/sim/implicit/ring_all.tex}
	\caption{Intersections with the plane of the target object. The target object is visualized as black circle. High repeatability and accuracy as long as damping is not overestimated.}
\end{figure}

\begin{figure}
	\centering
	\subfloat[Trajectory tracking without implicit feedback.]{
		\centering
		\input{plots/lab/explicit/ring.tex}
	}
	\subfloat[Mixed implicit feedback and tracking controller.]{
		\centering
		\input{plots/lab/mixed/ring.tex}
	}
\end{figure}


